<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Audit</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../../plugins/element-ui/index.css" />
    <link rel="stylesheet" href="../../styles/common.css" />
    <link rel="stylesheet" href="../../styles/page.css" />
</head>
<body>
<div class="dashboard-container" id="product-audit-app">
    <div class="container">
        <div class="tableBar" style="display: inline-block"></div>
        <el-table :data="tableData" stripe class="tableBox">
            <el-table-column prop="id" label="产品ID"></el-table-column>
            <el-table-column prop="name" label="产品名称"></el-table-column>
            <el-table-column prop="categoryName" label="分类"></el-table-column>
            <el-table-column prop="price" label="价格"></el-table-column>
            <el-table-column prop="stock" label="库存"></el-table-column>
            <el-table-column prop="description" label="描述"></el-table-column>
            <el-table-column prop="createTime" label="创建时间">
                <template slot-scope="scope">
                    {{ scope.row.createTime }}
                </template>
            </el-table-column>
            <el-table-column prop="image" label="图片" align="center">
                <template slot-scope="scope">
                    <el-image
                            style="width: auto; height: 40px; border: none; cursor: pointer;"
                            :src="getImage(scope.row.image)"
                            :preview-src-list="[getImage(scope.row.image)]"
                    >
                        <div slot="error" class="image-slot">
                            <img src="../../images/noImg.png" style="width: auto; height: 40px; border: none;">
                        </div>
                    </el-image>
                </template>
            </el-table-column>
            <el-table-column label="操作" width="200" align="center">
                <template slot-scope="scope">
                    <el-button
                            v-if="scope.row.status === 2"
                            type="text"
                            size="small"
                            class="blueBug"
                            @click="updateStatus(scope.row.id, 1)"
                    >
                        上架
                    </el-button>
                    <el-button
                            v-if="scope.row.status === 2"
                            type="text"
                            size="small"
                            class="delBut non"
                            @click="updateStatus(scope.row.id, 3)"
                    >
                        拒绝
                    </el-button>
                    <el-button
                            type="text"
                            size="small"
                            class="editBut"
                            @click="editProduct(scope.row)"
                    >
                        编辑
                    </el-button>
                </template>
            </el-table-column>
        </el-table>
        <el-pagination
                class="pageList"
                :page-sizes="[10, 20, 30, 40]"
                :page-size="pageSize"
                layout="total, sizes, prev, pager, next, jumper"
                :total="counts"
                @size-change="handleSizeChange"
                @current-change="handleCurrentChange"
        ></el-pagination>
    </div>

    <!-- 编辑产品弹窗 -->
    <el-dialog title="编辑产品" :visible.sync="dialogVisible">
        <el-form :model="form" label-width="120px">
            <el-form-item label="产品名称">
                <el-input v-model="form.name"></el-input>
            </el-form-item>
            <el-form-item label="分类">
                <el-select v-model="form.categoryId" placeholder="请选择分类">
                    <el-option v-for="item in categories" :key="item.id" :label="item.name" :value="item.id"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item label="价格">
                <el-input v-model="form.price" type="number"></el-input>
            </el-form-item>
            <el-form-item label="库存">
                <el-input v-model="form.stock" type="number"></el-input>
            </el-form-item>
            <el-form-item label="描述">
                <el-input type="textarea" v-model="form.description"></el-input>
            </el-form-item>
            <el-form-item label="图片">
                    <el-upload
                            class="upload-demo"
                            action="/common/upload"
                            :show-file-list="false"
                            :on-success="handleUploadSuccess"
                            :before-upload="beforeUpload"
                    >
                        <el-button type="primary">点击上传</el-button>
                    </el-upload>
                    <el-image
                            v-if="form.image"
                            :src="getImage(form.image)"
                            style="width: 100px; height: 100px; margin-top: 10px;"
                    >
                        <div slot="error" class="image-slot">
                            <img src="../../images/noImg.png" style="width: 100px; height: 100px;">
                        </div>
                    </el-image>
            </el-form-item>
<!--            <el-form-item label="参数">-->
<!--                <el-table :data="form.params" border>-->
<!--                    <el-table-column prop="name" label="参数名称"></el-table-column>-->
<!--                    <el-table-column prop="value" label="参数值"></el-table-column>-->
<!--                </el-table>-->
<!--            </el-form-item>-->
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">取消</el-button>
            <el-button type="primary" @click="submitForm">确定</el-button>
        </div>
    </el-dialog>
</div>
<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<script src="../../plugins/vue/vue.js"></script>
<!-- 引入组件库 -->
<script src="../../plugins/element-ui/index.js"></script>
<!-- 引入axios -->
<script src="../../plugins/axios/axios.min.js"></script>
<script src="../../js/request.js"></script>
<script src="../../api/productAudit.js"></script>
<script type="module">
    // import { getProductPage, updateProduct, updateProductStatus, getCategories } from '../../api/productAudit.js';
    new Vue({
        el: '#product-audit-app',
        data() {
            return {
                counts: 0,
                page: 1,
                pageSize: 10,
                tableData: [],
                dialogVisible: false,
                form: {
                    id: null,
                    name: '',
                    categoryId: null,
                    price: null,
                    stock: null,
                    description: '',
                    status: 2,
                    params: []
                },
                categories: []
            }
        },
        created() {
            this.init();
            this.fetchCategories();
        },
        methods: {
            async init() {
                try {
                    const res = await getProductPage({ page: this.page, pageSize: this.pageSize });
                    if (res.code === 1) {
                        this.tableData = res.data.records.filter(record => record.status === 2); // Filter only pending products
                        this.counts = res.data.total;
                    } else {
                        this.$message.error(res.msg || '操作失败');
                    }
                } catch (err) {
                    this.$message.error('请求出错了：' + err);
                }
            },
            async fetchCategories() {
                try {
                    const res = await getCategories();
                    if (res.code === 1) {
                        this.categories = res.data;
                    } else {
                        this.$message.error(res.msg || '获取分类失败');
                    }
                } catch (err) {
                    this.$message.error('请求出错了：' + err);
                }
            },
            getImage(image) {
                return `/common/download?name=${image}`;
            },
            getStatus(status) {
                switch (status) {
                    case 0:
                        return '停售';
                    case 1:
                        return '起售';
                    case 2:
                        return '待审核';
                    case 3:
                        return '拒绝';
                    default:
                        return '未知';
                }
            },
            async updateStatus(id, status) {
                try {
                    const res = await updateProductStatus({ id, status });
                    if (res.code === 1) {
                        this.$message.success('状态更新成功');
                        this.init(); // Refresh data
                    } else {
                        this.$message.error(res.msg || '操作失败');
                    }
                } catch (err) {
                    this.$message.error('请求出错了：' + err);
                }
            },
            editProduct(product) {
                this.form = { ...product };
                this.dialogVisible = true;
            },
            async submitForm() {
                try {
                    const res = await updateProduct(this.form);
                    if (res.code === 1) {
                        this.$message.success('产品更新成功');
                        this.dialogVisible = false;
                        this.init(); // Refresh data
                    } else {
                        this.$message.error(res.msg || '操作失败');
                    }
                } catch (err) {
                    this.$message.error('请求出错了：' + err);
                }
            },
            handleUploadSuccess(response, file) {
                this.form.image = response.data; // Assuming the response contains the image path in data
                this.$message.success('图片上传成功');
            },
            beforeUpload(file) {
                const isJPG = file.type === 'image/jpeg';
                const isPNG = file.type === 'image/png';
                const isLt2M = file.size / 1024 / 1024 < 2;

                if (!isJPG && !isPNG) {
                    this.$message.error('上传图片只能是 JPG 或 PNG 格式!');
                    return false;
                }
                if (!isLt2M) {
                    this.$message.error('上传图片大小不能超过 2MB!');
                    return false;
                }
                return true;
            },
            handleSizeChange(val) {
                this.pageSize = val;
                this.init();
            },
            handleCurrentChange(val) {
                this.page = val;
                this.init();
            }
        }
    });
</script>
</body>
</html>
